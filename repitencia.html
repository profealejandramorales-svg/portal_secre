<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Decreto 67 - Informe Acad√©mico</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* UI Pantalla */
        .tab-btn { transition: all 0.2s; border-bottom: 3px solid transparent; opacity: 0.7; }
        .tab-btn:hover { opacity: 1; background-color: #e2e8f0; }
        .tab-btn.active { border-color: #166534; color: #166534; font-weight: bold; background-color: #dcfce7; opacity: 1; }

        input.editable, textarea.editable, select.editable {
            border: 1px solid #94a3b8; background-color: #ffffff;
            border-radius: 0.375rem; padding: 0.5rem; width: 100%; font-size: 0.95rem;
        }
        input.editable:focus { outline: none; border-color: #16a34a; box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2); }

        /* Estilo Hoja de Vida (Tutor√≠a) en Pantalla */
        .sheet-paper {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            font-family: 'Times New Roman', serif;
            color: black;
            min-height: 800px;
        }
        .sheet-table th, .sheet-table td { border: 1px solid black; padding: 4px 8px; font-size: 10pt; vertical-align: top; }
        .sheet-table th { background-color: #f3f4f6; font-weight: bold; text-transform: uppercase; font-size: 9pt; }

        /* --- MEJORAS DE IMPRESI√ìN --- */
        @media print {
            body { background: white; }
            body * { visibility: hidden; } 
            
            #print-zone, #print-zone * {
                visibility: visible !important;
                display: block !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            #print-zone {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
            }
            
            img { display: block !important; visibility: visible !important; }

            .no-print { display: none !important; }
            @page { size: letter; margin: 1.5cm; } 
            
            .doc-container { 
                font-family: 'Times New Roman', serif; 
                color: black; 
                line-height: 1.3;
                font-size: 11pt;
            }
            .doc-header { display: flex; justify-content: space-between; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .doc-title { text-align: center; font-weight: bold; font-size: 14pt; text-decoration: underline; margin-bottom: 20px; text-transform: uppercase; }
            .doc-section { font-weight: bold; border-bottom: 1px solid #000; margin-top: 20px; margin-bottom: 10px; font-size: 11pt; text-transform: uppercase; }
            .doc-box { border: 1px solid #000; padding: 10px; min-height: 50px; white-space: pre-wrap; text-align: justify; margin-bottom: 10px; }
            .doc-signatures { display: flex; justify-content: space-between; margin-top: 80px; page-break-inside: avoid; }
            .doc-sign-line { width: 40%; border-top: 1px solid black; text-align: center; font-weight: bold; padding-top: 5px; font-size: 10pt; }
            
            table.print-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10pt; }
            table.print-table th, table.print-table td { border: 1px solid black; padding: 5px; text-align: left; vertical-align: top; }
            table.print-table th { background-color: #eee !important; -webkit-print-color-adjust: exact; font-weight: bold; text-align: center; }
        }
    </style>
</head>
<body class="pb-12">

    <header class="bg-green-800 text-white shadow-lg no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="logo.jpg" alt="Logo" class="h-12 bg-white rounded p-1" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-lg font-bold">Gesti√≥n Decreto 67</h1>
                    <p class="text-green-200 text-xs">Informe Avance Tutor√≠a-Repitencia ‚Ä¢ Desarrollado por ProfeAle</p>
                </div>
            </div>
            <div class="text-right flex gap-2">
                <div id="connection-status" class="text-xs bg-yellow-500 text-black px-2 py-1 rounded">Conectando...</div>
                <button onclick="saveData()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold shadow text-sm flex items-center gap-2">
                    <i class="fas fa-save"></i> GUARDAR
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200 mb-6 no-print">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">1. Curso</label>
                    <select id="course-select" class="w-full p-2 border rounded bg-gray-50 font-bold text-gray-700" onchange="filterStudents()">
                        <option value="">Cargando n√≥mina...</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">2. Estudiante</label>
                    <select id="student-select" class="w-full p-2 border rounded disabled:bg-gray-100" disabled onchange="loadStudentFromList()">
                        <option value="">‚Üê Seleccione curso</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap border-b border-gray-200 bg-white rounded-t-lg no-print">
            <button onclick="switchTab('ficha')" id="btn-ficha" class="tab-btn active flex-1 py-3 px-2 text-sm"><i class="fas fa-id-card"></i> Ficha</button>
            <button onclick="switchTab('analisis')" id="btn-analisis" class="tab-btn flex-1 py-3 px-2 text-sm"><i class="fas fa-chart-pie"></i> An√°lisis</button>
            <button onclick="switchTab('decision')" id="btn-decision" class="tab-btn flex-1 py-3 px-2 text-sm"><i class="fas fa-gavel"></i> Resoluci√≥n</button>
            <button onclick="switchTab('tutoria')" id="btn-tutoria" class="tab-btn flex-1 py-3 px-2 text-sm"><i class="fas fa-hands-helping"></i> Tutor√≠a (Bit√°cora)</button>
            <button onclick="switchTab('historial')" id="btn-historial" class="tab-btn flex-1 py-3 px-2 text-sm bg-yellow-50 text-yellow-800 font-bold border-yellow-200"><i class="fas fa-folder-open"></i> 5. Gesti√≥n e Historial</button>
        </div>

        <div class="bg-white p-6 rounded-b-lg shadow-sm border border-t-0 border-gray-200 min-h-[600px] no-print relative">
            
            <div id="tab-ficha" class="view-section">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Identificaci√≥n del Estudiante</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="text-xs font-bold text-gray-500">Nombre Completo</label><input type="text" id="inp-nombre" class="editable font-bold" oninput="updateTutoriaHeader()"></div>
                    <div><label class="text-xs font-bold text-gray-500">RUT</label><input type="text" id="inp-rut" class="editable font-bold"></div>
                    <div><label class="text-xs font-bold text-gray-500">Curso</label><input type="text" id="inp-curso" class="editable" oninput="updateTutoriaHeader()"></div>
                    <div><label class="text-xs font-bold text-gray-500">Profesor Jefe / Tutor</label><input type="text" id="inp-profesor" class="editable"></div>
                </div>
            </div>

            <div id="tab-analisis" class="view-section hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">An√°lisis de Brecha (Decreto 67)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                    <div class="bg-gray-50 p-4 rounded border">
                        <h4 class="font-bold text-sm mb-2 text-blue-800">Calificaciones</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs">Semestre 1</label><input type="number" id="inp-sem1" class="editable text-center font-bold" onchange="updateChart()"></div>
                            <div><label class="text-xs">Semestre 2</label><input type="number" id="inp-sem2" class="editable text-center font-bold" onchange="updateChart()"></div>
                        </div>
                        <div class="mt-4"><label class="text-xs">Promedio Curso</label><input type="number" id="inp-prom-curso" value="5.5" class="editable text-center w-24" onchange="updateChart()"></div>
                    </div>
                    <div class="h-48 w-full"><canvas id="gapChart"></canvas></div>
                </div>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-gray-500">An√°lisis Pedag√≥gico (Progreso y Brecha)</label><textarea id="inp-analisis-ped" class="editable h-24"></textarea></div>
                    <div><label class="text-xs font-bold text-gray-500">Factores Socioemocionales</label><textarea id="inp-analisis-soc" class="editable h-24"></textarea></div>
                </div>
            </div>

            <div id="tab-decision" class="view-section hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Resoluci√≥n del Caso</h3>
                <div class="flex justify-between items-center mb-4 bg-gray-100 p-3 rounded">
                    <span class="font-bold">Decisi√≥n Final:</span>
                    <select id="inp-decision" class="p-2 border-2 border-blue-500 rounded font-bold text-blue-800">
                        <option value="Repitencia">REPITENCIA</option>
                        <option value="Aprobaci√≥n">APROBACI√ìN (Promovido)</option>
                    </select>
                </div>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-gray-500">Fundamentaci√≥n de la Decisi√≥n</label><textarea id="inp-fundamentacion" class="editable h-32"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">Asignaturas Cr√≠ticas</label><textarea id="inp-asignaturas" class="editable h-20"></textarea></div>
                        <div><label class="text-xs font-bold text-gray-500">% Asistencia Final</label><input type="text" id="inp-asistencia" class="editable"></div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="printReport('repitencia')" class="bg-gray-800 text-white px-8 py-3 rounded-full hover:bg-black font-bold shadow-lg">
                        <i class="fas fa-print"></i> IMPRIMIR INFORME REPITENCIA
                    </button>
                </div>
            </div>

            <div id="tab-tutoria" class="view-section hidden">
                <div class="flex flex-col lg:flex-row gap-6">
                    
                    <div class="w-full lg:w-1/3 space-y-4">
                        
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 class="text-sm font-bold text-blue-900 uppercase mb-3 border-b border-blue-200 pb-1">Nuevo Registro</h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Semestre</label>
                                    <select id="tut-semestre" class="w-full p-2 border rounded bg-white">
                                        <option value="1">1¬∞ Semestre</option>
                                        <option value="2">2¬∞ Semestre</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Fecha Entrevista</label>
                                    <input type="date" id="tut-fecha" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Observaci√≥n / Tema Tratado</label>
                                    <textarea id="tut-obs" rows="3" class="w-full p-2 border rounded" placeholder="Ej: Revisi√≥n de notas parciales..."></textarea>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Acuerdos / Compromisos</label>
                                    <textarea id="tut-acuerdos" rows="3" class="w-full p-2 border rounded" placeholder="Ej: Estudiar para prueba de..."></textarea>
                                </div>
                                
                                <button onclick="addTutoriaRow()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow transition">
                                    <i class="fas fa-plus-circle"></i> Agregar a la Hoja
                                </button>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                            <details>
                                <summary class="font-bold text-yellow-800 text-sm cursor-pointer hover:text-yellow-900 flex items-center gap-2">
                                    <i class="fas fa-lightbulb"></i> Tips para Redacci√≥n Formal
                                </summary>
                                <div class="mt-3 text-xs text-gray-700 space-y-2">
                                    <p><strong>Verbos para Observaciones:</strong></p>
                                    <ul class="list-disc pl-4 italic">
                                        <li>Se evidencia dificultad en...</li>
                                        <li>Manifiesta inter√©s por...</li>
                                        <li>Se observa un descenso en...</li>
                                        <li>Presenta inasistencias injustificadas...</li>
                                    </ul>
                                    <p><strong>Verbos para Acuerdos:</strong></p>
                                    <ul class="list-disc pl-4 italic">
                                        <li>Se compromete a asistir a...</li>
                                        <li>Regularizar√° entrega de...</li>
                                        <li>Mantendr√° comunicaci√≥n v√≠a...</li>
                                        <li>Apoderado supervisar√° estudio...</li>
                                    </ul>
                                </div>
                            </details>
                        </div>

                        <hr class="border-blue-200">
                        
                        <div>
                            <label class="text-xs font-bold text-gray-500">Profesor Tutor (Firma)</label>
                            <input type="text" id="inp-tutor" class="w-full p-2 border rounded mb-2" placeholder="Nombre Profesor" oninput="updateTutoriaHeader()">
                        </div>

                        <button onclick="printReport('tutoria')" class="w-full bg-gray-800 text-white font-bold py-3 rounded shadow hover:bg-black transition">
                            <i class="fas fa-print"></i> IMPRIMIR PLANILLA
                        </button>
                    </div>

                    <div class="w-full lg:w-2/3 overflow-y-auto bg-gray-200 p-4 rounded border-inner shadow-inner flex justify-center">
                        <div id="hoja-tutoria-visual" class="sheet-paper w-full max-w-[21cm]">
                            
                            <div class="flex justify-between border-b-2 border-black pb-2 mb-4">
                                <div class="flex items-center gap-4">
                                    <img src="logo.jpg" alt="Logo Colegio" style="height: 60px; width: auto; object-fit: contain;" onerror="this.style.display='none'">
                                    <div class="text-left">
                                        <h2 class="font-bold text-lg uppercase leading-tight">Escuela Agr√≠cola<br>Sagrados Corazones</h2>
                                        <p class="text-xs italic">Unidad T√©cnico Pedag√≥gica</p>
                                    </div>
                                </div>
                                <div class="text-right text-xs pt-2">
                                    <p><strong>REGISTRO DE ACOMPA√ëAMIENTO</strong></p>
                                    <p>Decreto Evaluaci√≥n 67</p>
                                </div>
                            </div>

                            <table class="w-full text-sm mb-6">
                                <tr>
                                    <td class="font-bold w-24">ESTUDIANTE:</td>
                                    <td class="border-b border-black px-2" id="view-nombre"></td>
                                    <td class="font-bold w-16 text-right px-2">CURSO:</td>
                                    <td class="border-b border-black w-20 text-center" id="view-curso"></td>
                                </tr>
                                <tr>
                                    <td class="font-bold pt-2">TUTOR:</td>
                                    <td class="border-b border-black px-2 pt-2" colspan="3" id="view-tutor"></td>
                                </tr>
                            </table>

                            <div class="mb-6">
                                <div class="bg-gray-200 border border-black text-center font-bold text-xs py-1 uppercase">Primer Semestre</div>
                                <table class="w-full sheet-table border-collapse" id="table-sem1">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">FECHA</th>
                                            <th>OBSERVACIONES / TEMAS TRATADOS</th>
                                            <th>ACUERDOS Y COMPROMISOS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        </tbody>
                                </table>
                            </div>

                            <div class="mb-8">
                                <div class="bg-gray-200 border border-black text-center font-bold text-xs py-1 uppercase">Segundo Semestre</div>
                                <table class="w-full sheet-table border-collapse" id="table-sem2">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">FECHA</th>
                                            <th>OBSERVACIONES / TEMAS TRATADOS</th>
                                            <th>ACUERDOS Y COMPROMISOS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        </tbody>
                                </table>
                            </div>

                            <div class="mt-12 flex justify-between px-8 text-center text-xs">
                                <div class="w-5/12 border-t border-black pt-1">
                                    <span class="font-bold block" id="view-sign-tutor"></span>
                                    Firma Profesor Tutor
                                </div>
                                <div class="w-5/12 border-t border-black pt-1">
                                    <span class="font-bold block">Estudiante / Apoderado</span>
                                    Toma de Conocimiento
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-historial" class="view-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">üóÇÔ∏è Informes Guardados</h3>
                    <button onclick="loadHistory()" class="text-sm bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 border border-blue-200">
                        üîÑ Cargar Historial
                    </button>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                            <tr>
                                <th class="px-4 py-3">Fecha</th>
                                <th class="px-4 py-3">Tipo</th>
                                <th class="px-4 py-3">Estudiante</th>
                                <th class="px-4 py-3">Curso</th>
                                <th class="px-4 py-3 text-right">Ver</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">Presiona "Cargar Historial" para ver los datos.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="print-zone" class="hidden"></div>

    <script>
        // === 1. CONFIGURACI√ìN FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyAisxzJVm2OzjYEXSi4Q7HxZEUG_aarQwo",
            authDomain: "notas-liceo-agricola-sscc.firebaseapp.com",
            databaseURL: "https://notas-liceo-agricola-sscc-default-rtdb.firebaseio.com",
            projectId: "notas-liceo-agricola-sscc",
            storageBucket: "notas-liceo-agricola-sscc.firebasestorage.app",
            messagingSenderId: "434804825732",
            appId: "1:434804825732:web:8c9035fa88be54cd6facd1"
        };

        const SCHOOL_NAME = "Escuela Agr√≠cola Sagrados Corazones"; 
        const LOCATION = "Villa Alegre";

        // N√ìMINA OFICIAL 2026 (ACTUALIZADA)
        const STUDENTS_DATA = [
            ['Primero Medio A', '23756366-2', '', '√ÅLVAREZ FA√öNDEZ MATEO VICENTE'], ['Primero Medio A', '23632281-5', '', 'CASTILLO ARAVENA MAITE PASCAL'], ['Primero Medio A', '23630802-2', '', 'COLLADO PUENTES SANTINO ALEXANDER'], ['Primero Medio A', '23466096-9', '', 'CONCHA TORREALBA JOAQU√çN IGNACIO'], ['Primero Medio A', '23797819-6', '', 'D√çAZ MALUENDA ESTEFAN√çA ANTONIA'], ['Primero Medio A', '23927686-5', '', 'DONAIRE ROJAS MAITE EMILIA ESTER'], ['Primero Medio A', '23552792-8', '', 'ESPINOZA CACHA√ëA LISBET ALEXANDRA'], ['Primero Medio A', '23560082-K', '', 'FERRADA ALBORNOZ AGUST√çN ALEXIS'], ['Primero Medio A', '23329694-5', '', 'FUENTEMAVIDA BARROS OSCAR ANTONIO'], ['Primero Medio A', '23620840-0', '', 'JAQUE PACHECO DAMI√ÅN IGNACIO'], ['Primero Medio A', '23308540-5', '', 'JARAMILLO VILLAR MATT HOST'], ['Primero Medio A', '23355954-7', '', 'L√ìPEZ ACU√ëA MARCO EMILIO'], ['Primero Medio A', '23903961-8', '', 'L√ìPEZ VILLAR FRANCO IGNACIO'], ['Primero Medio A', '23032545-6', '', 'MESA D√çAZ GONZALO IGNACIO'], ['Primero Medio A', '23520544-0', '', 'MEZA CARRASCO CRISTIAN ALFONSO'], ['Primero Medio A', '23668420-2', '', 'MORALES GARRIDO NICOL√ÅS ANTONIO'], ['Primero Medio A', '23830831-3', '', 'ORTEGA DA SILVA EMILIA CATALINA SOPHIA'], ['Primero Medio A', '23653817-6', '', 'PEREIRA TAPIA KEVIN RUB√âN'], ['Primero Medio A', '23679011-8', '', 'RAM√çREZ SEP√öLVEDA LUIS JUSTIN JES√öS'], ['Primero Medio A', '23488123-K', '', 'RAM√çREZ VALD√âS MARTINA POLETTE'], ['Primero Medio A', '23493746-4', '', 'RECABAL Y√Å√ëEZ TOM√ÅS IGNACIO'], ['Primero Medio A', '22988470-0', '', 'RODR√çGUEZ SEP√öLVEDA SIMONEY ISAMAR'], ['Primero Medio A', '23710287-8', '', 'ROJAS √ìRDENES TRACY MAIDEN'], ['Primero Medio A', '23577058-K', '', 'S√ÅNCHEZ MUNIZAGA ALONDRA ANA√çS'], ['Primero Medio A', '100685011-8', '', 'SOLIZ OLGUIN BRAYAN'], ['Primero Medio A', '23937949-4', '', 'VALENZUELA MU√ëOZ MAGDALENA BEL√âN'],
            ['Segundo Medio A', '23376817-0', '', 'ALBURQUENQUE DEL GRECCO EMILYA ANTONIA'], ['Segundo Medio A', '22922460-3', '', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS'], ['Segundo Medio A', '23367234-3', '', 'ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS'], ['Segundo Medio A', '22927087-7', '', 'ARAYA DOM√çNGUEZ ALEX FABI√ÅN'], ['Segundo Medio A', '22826488-1', '', 'ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO'], ['Segundo Medio A', '23251746-8', '', 'ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN'], ['Segundo Medio A', '23461777-K', '', 'BAEZ DONOSO LUKAS ALFONSO'], ['Segundo Medio A', '23282399-2', '', 'CARO BUSTOS KRISCHNA ESTEFANIA'], ['Segundo Medio A', '23355953-9', '', 'CONTRERAS SALGADO HADEEY ALEJANDRA'], ['Segundo Medio A', '23545428-9', '', 'CUMINAO VIDAL CATALINA ANDREA'], ['Segundo Medio A', '23224652-9', '', 'D√çAZ MALUENDA MIGUEL ALBERTO'], ['Segundo Medio A', '23644472-4', '', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA'], ['Segundo Medio A', '23337375-3', '', 'KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL'], ['Segundo Medio A', '23389072-3', '', 'LAGOS LASTRA ALEXANDRA DANAE'], ['Segundo Medio A', '23498596-5', '', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO'], ['Segundo Medio A', '23153879-8', '', 'L√ìPEZ NOVOA EYDAN DAMI√ÅN'], ['Segundo Medio A', '23396870-6', '', 'MALDONADO FLORES ANTONELLA BEL√âN'], ['Segundo Medio A', '23548214-2', '', 'MONTECINO D√çAZ VALESKA BEL√âN'], ['Segundo Medio A', '23391772-9', '', 'MOYA REYES MATEO ANTONIO BENJAM√çN'], ['Segundo Medio A', '23366642-4', '', 'MU√ëOZ CONTRERAS LUIS GABRIEL'], ['Segundo Medio A', '23622121-0', '', 'MU√ëOZ LUNA ROGER JOEL'], ['Segundo Medio A', '23329866-2', '', 'NAVARRO VILLANUEVA KARLA PAZ'], ['Segundo Medio A', '23388136-8', '', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS'], ['Segundo Medio A', '23432193-5', '', 'OSES CAMPOS VALENTINA ABIGAIL'], ['Segundo Medio A', '23190411-5', '', 'PALMA ORELLANA ANTONELLA FRANCISCA'], ['Segundo Medio A', '23605196-K', '', 'PEREIRA ORELLANA MONSERRAT ALAMIRA'], ['Segundo Medio A', '23415461-3', '', 'P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA'], ['Segundo Medio A', '23479449-3', '', 'P√âREZ QUEVEDO CONSTANZA TRINIDAD'], ['Segundo Medio A', '23640108-1', '', 'QUEZADA NARANJO FELIPE ALONSO'], ['Segundo Medio A', '23534317-7', '', 'RAM√çREZ VILLALOBOS DUVAN EMILIO'], ['Segundo Medio A', '23112966-9', '', 'RIQUELME SANTOS BENJAM√çN ALONSO'], ['Segundo Medio A', '23290841-6', '', 'ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD'], ['Segundo Medio A', '23264828-7', '', 'ROJAS LEIVA EDUARDO JAVIER'], ['Segundo Medio A', '23301500-8', '', 'SALAZAR SALAS PEDRO JOS√â'], ['Segundo Medio A', '23679554-3', '', 'SANTANDER L√ìPEZ MAR√çA JOS√â'], ['Segundo Medio A', '23631475-8', '', 'TAPIA CASTILLA JEANFRANCO PATRICK'], ['Segundo Medio A', '23007625-1', '', 'URBINA C√ÅCERES FRANCHESCA POULETTE'], ['Segundo Medio A', '23555453-4', '', 'VARGAS MORAGA MARTINA SAYEN'], ['Segundo Medio A', '22763630-0', '', 'V√ÅSQUEZ AGUILERA SCARLET NICOLE'], ['Segundo Medio A', '23584521-0', '', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL'], ['Segundo Medio A', '23296637-8', '', 'VERA BRAVO FLORENCIA ANTONIA'], ['Segundo Medio A', '23616701-1', '', 'Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN'], ['Segundo Medio A', '23404221-1', '', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS'],
            ['Tercero Medio A', '23006149-1', '', 'AHUMADA ROJAS TRINIDAD BEL√âN'], ['Tercero Medio A', '22774362-K', '', 'CORNEJO CASTILLO OSCAR GABRIEL'], ['Tercero Medio A', '23236242-1', '', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS'], ['Tercero Medio A', '23229539-2', '', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO'], ['Tercero Medio A', '22827535-2', '', 'JARAMILLO VILLAR EMILIO SCOTT'], ['Tercero Medio A', '23321258-K', '', 'L√ìPEZ VILLAR MART√çN ALONSO'], ['Tercero Medio A', '23255825-3', '', 'MEZA COLIM√ÅN ANGEL BLAS'], ['Tercero Medio A', '23285276-3', '', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA'], ['Tercero Medio A', '22932822-0', '', 'MORAGA PACHECO RENATO IGNACIO'], ['Tercero Medio A', '22617512-1', '', 'MORALES REIM√ÅN ALFONSO TOM√ÅS'], ['Tercero Medio A', '22876195-8', '', 'ORELLANA GARRIDO MAT√çAS LEANDRO'], ['Tercero Medio A', '23054557-K', '', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO'], ['Tercero Medio A', '23029359-7', '', 'PINTO TOBAR JORD√ÅN AMARO'], ['Tercero Medio A', '23086976-6', '', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS'], ['Tercero Medio A', '22922664-9', '', 'SANDOVAL CERPA VICENTE ESTEBAN'], ['Tercero Medio A', '23230279-8', '', 'SOTO NARANJO CHRISTOPHER'], ['Tercero Medio A', '22907717-1', '', 'VEKARIC VERDEJO MART√çN'], ['Tercero Medio A', '23146366-6', '', 'VIELMA ZABALAGA JOAN MANUEL'],
            ['Tercero Medio C', '23099931-7', '', 'BRAVO MENARES ALEX JOHAN'], ['Tercero Medio C', '23200990-K', '', 'CARRASCO LEIVA BENJAM√çN IGNACIO'], ['Tercero Medio C', '23194660-8', '', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER'], ['Tercero Medio C', '23090163-5', '', 'ESPINOSA TORRES FERNANDA ELENA'], ['Tercero Medio C', '23121508-5', '', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA'], ['Tercero Medio C', '23132468-2', '', 'MEDEL OJEDA LE√ìN IGNACIO'], ['Tercero Medio C', '23097156-0', '', 'OLIVARES VALENZUELA ALONSO IGNACIO'], ['Tercero Medio C', '22804086-K', '', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA'], ['Tercero Medio C', '23113000-4', '', 'PUNOY MEDEL MILLARAY ANG√âLICA'], ['Tercero Medio C', '23118361-2', '', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO'], ['Tercero Medio C', '23284002-1', '', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO'], ['Tercero Medio C', '23244598-K', '', 'RIQUELME COLOMA DALIA CONSTANZA'], ['Tercero Medio C', '23141589-0', '', 'RIVERA ABARZA CONSTANZA VICTORIA'], ['Tercero Medio C', '23164383-4', '', 'SAAVEDRA BRAVO FLORENCIA ALEJANDRA'], ['Tercero Medio C', '23304433-4', '', 'SALGADO ROJAS VICENTE MOIS√âS'], ['Tercero Medio C', '23294557-5', '', 'SANTIS CASSEUS TEIVA SCARLETT'], ['Tercero Medio C', '22912548-6', '', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN'], ['Tercero Medio C', '23209204-1', '', 'TOLEDO ALBORNOZ ANTONELLA INES'], ['Tercero Medio C', '23115030-7', '', 'VENEGAS ARRIAGADA ANTONIA EDITH'],
            ['Cuarto Medio A', '22717035-2', '', 'ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA'], ['Cuarto Medio A', '22202028-K', '', 'BAHAMONDE MU√ëOZ ARIEL LEON'], ['Cuarto Medio A', '22932851-4', '', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS'], ['Cuarto Medio A', '22587064-0', '', 'CANCINO OR√ìSTICA VICENTE GASPAR'], ['Cuarto Medio A', '23038091-0', '', 'CARO URRUTIA CONSUELO ANTONIA'], ['Cuarto Medio A', '22935345-4', '', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA'], ['Cuarto Medio A', '22852052-7', '', 'COFR√â CASTILLO ANTONIO ANDR√âS'], ['Cuarto Medio A', '22897408-0', '', 'GALDAMES VERGARA FELIPE ESTEBAN'], ['Cuarto Medio A', '22152106-4', '', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO'], ['Cuarto Medio A', '22820588-5', '', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA'], ['Cuarto Medio A', '22565627-4', '', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO'], ['Cuarto Medio A', '22808692-4', '', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN'], ['Cuarto Medio A', '22644932-9', '', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO'], ['Cuarto Medio A', '22448022-9', '', 'LOBOS C√ÅCERES ANTONIA PAZ'], ['Cuarto Medio A', '22970003-0', '', 'MART√çNEZ LIZANA AARON ALEJANDRO'], ['Cuarto Medio A', '22482618-4', '', 'MEZA CARRASCO BENJAM√çN INTI'], ['Cuarto Medio A', '22858572-6', '', 'MI√ëO GONZALEZ CATALINA ANDREA'], ['Cuarto Medio A', '22932822-0', '', 'MORAGA PACHECO RENATO IGNACIO'], ['Cuarto Medio A', '22839912-4', '', 'P√âREZ COR√ìN MANUEL IGNACIO'], ['Cuarto Medio A', '100710921-7', '', 'SAMANIEGO CORTEZ JAKSON FERGIE'], ['Cuarto Medio A', '22889391-9', '', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA'], ['Cuarto Medio A', '22709426-5', '', 'TAPIA ACU√ëA GABRIEL ANTONIO'], ['Cuarto Medio A', '100793606-7', '', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES'], ['Cuarto Medio A', '23022549-4', '', 'VEGA VIVANCO CRIST√ìBAL ANTONIO'], ['Cuarto Medio A', '22903476-6', '', 'VERA NAVARRETE DANIELA ELIZABETH'], ['Cuarto Medio A', '22792420-9', '', 'VILLALOBOS ARAVENA KARINA ANGELINA'], ['Cuarto Medio A', '22733377-4', '', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS'],
            ['Cuarto Medio C', '22558171-1', '', 'ARELLANO ACU√ëA MART√çN ANTONIO'], ['Cuarto Medio C', '22897577-K', '', 'AROS √ÅVILA DAYANA IGNACIA'], ['Cuarto Medio C', '22339310-1', '', 'CABRERA COLOMBINO MAR√çA GRACIA'], ['Cuarto Medio C', '23048274-8', '', 'COLLAO MEDINA ANA√çS VALENTINA'], ['Cuarto Medio C', '22783846-9', '', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN'], ['Cuarto Medio C', '22865819-7', '', 'FUENTES CARRASCO YARIXA ALEJANDRA'], ['Cuarto Medio C', '22971225-K', '', 'G√ìMEZ CANCINO DANIELA ALEJANDRA'], ['Cuarto Medio C', '22698950-1', '', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA'], ['Cuarto Medio C', '22665539-5', '', 'HONORATO TAPIA GLORIA JAVIERA'], ['Cuarto Medio C', '22907525-K', '', 'LARA RIVERA BENJAM√çN ESTEBAN'], ['Cuarto Medio C', '22801082-0', '', 'PALACIOS SOTO JOS√â TOM√ÅS'], ['Cuarto Medio C', '22477831-7', '', 'PEZO SANTANDER JOS√â CRIST√ìBAL'], ['Cuarto Medio C', '22796354-9', '', 'ROCHA ROJAS JOS√â PABLO WILLIAMS'], ['Cuarto Medio C', '22876139-7', '', 'ROJAS Y√âVENES FABIANA ISIDORA'], ['Cuarto Medio C', '22916573-9', '', 'S√ÅNCHEZ PAREJA ANDY ANTONIO'], ['Cuarto Medio C', '22845486-9', '', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN'], ['Cuarto Medio C', '23004590-9', '', 'TRONCOSO LIZAMA SIOMARA IGNACIA'], ['Cuarto Medio C', '23009921-9', '', 'WARNKEN ROJAS LUCIANA BERNABELA']
        ];

        let db, chartInstance = null;

        // INICIALIZACI√ìN
        window.onload = function() {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            const auth = firebase.auth();

            auth.signInAnonymously().then(() => {
                document.getElementById('connection-status').innerText = "Conectado ‚úÖ";
                document.getElementById('connection-status').classList.remove('bg-yellow-500', 'text-black');
                document.getElementById('connection-status').classList.add('bg-green-600', 'text-white');
                populateDropdowns();
                loadHistory(); 
                
                document.getElementById('tut-fecha').valueAsDate = new Date();
                
            }).catch((error) => {
                console.error("Error Auth:", error);
                document.getElementById('connection-status').innerText = "Error Conexi√≥n ‚ùå";
                document.getElementById('connection-status').classList.add('bg-red-600', 'text-white');
            });
        };

        function populateDropdowns() {
            const courseSelect = document.getElementById('course-select');
            courseSelect.innerHTML = '<option value="">-- Seleccione un Curso --</option>'; // Limpiar antes de llenar
            
            // Obtener cursos √∫nicos
            const uniqueCourses = [...new Set(STUDENTS_DATA.map(s => s[0]))];
            
            // ORDEN PERSONALIZADO: Primero, Segundo, Tercero, Cuarto
            const order = { 'Primero': 1, 'Segundo': 2, 'Tercero': 3, 'Cuarto': 4 };
            uniqueCourses.sort((a, b) => {
                const wordA = a.split(' ')[0]; // "Primero", "Segundo", etc.
                const wordB = b.split(' ')[0];
                return (order[wordA] || 99) - (order[wordB] || 99) || a.localeCompare(b);
            });

            // Llenar el select
            uniqueCourses.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                courseSelect.appendChild(opt);
            });
        }

        window.filterStudents = () => {
            const course = document.getElementById('course-select').value;
            const select = document.getElementById('student-select');
            select.innerHTML = '<option value="">-- Seleccione Alumno --</option>';
            select.disabled = true;
            if(course) {
                STUDENTS_DATA.filter(s => s[0] === course).forEach(s => {
                    const fullName = `${s[3]} ${s[2]}`;
                    select.innerHTML += `<option value="${s[1]}">${fullName}</option>`;
                });
                select.disabled = false;
            }
        };

        window.loadStudentFromList = () => {
            const rut = document.getElementById('student-select').value;
            const student = STUDENTS_DATA.find(s => s[1] === rut);
            if(student) {
                const fullName = `${student[3]} ${student[2]}`;
                document.getElementById('inp-nombre').value = fullName;
                document.getElementById('inp-rut').value = student[1];
                document.getElementById('inp-curso').value = student[0];
                
                updateTutoriaHeader();
            }
        };

        window.updateChart = () => {
            const ctx = document.getElementById('gapChart');
            const p1 = parseFloat(document.getElementById('inp-sem1').value) || 0;
            const p2 = parseFloat(document.getElementById('inp-sem2').value) || 0;
            const final = (p1 && p2) ? (p1+p2)/2 : 0;
            const curso = parseFloat(document.getElementById('inp-prom-curso').value) || 5.5;

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Estudiante', 'Prom. Curso'],
                    datasets: [{
                        label: 'Notas',
                        data: [final, curso],
                        backgroundColor: [final<4?'#ef4444':'#3b82f6', '#94a3b8']
                    }]
                },
                options: { responsive:true, maintainAspectRatio: false, scales: { y: { min:1, max:7 } } }
            });
        };

        // --- GESTI√ìN DE DATOS ---
        window.saveData = async () => {
            const rut = document.getElementById('inp-rut').value;
            if(!rut) { Swal.fire('Falta RUT', 'Seleccione un alumno.', 'warning'); return; }

            const reportData = {
                reportInfo: { number: "MANUAL-" + Date.now().toString().substr(-4) },
                student: {
                    name: document.getElementById('inp-nombre').value,
                    run: rut,
                    course: document.getElementById('inp-curso').value,
                    tutor: document.getElementById('inp-profesor').value
                },
                academic: {
                    sem1Avg: document.getElementById('inp-sem1').value,
                    sem2Avg: document.getElementById('inp-sem2').value,
                    courseAvg: document.getElementById('inp-prom-curso').value,
                    failedSubjectsText: document.getElementById('inp-asignaturas').value 
                },
                decree67Analysis: {
                    progress: document.getElementById('inp-analisis-ped').value,
                    socioemotional: document.getElementById('inp-analisis-soc').value
                },
                decision: {
                    status: document.getElementById('inp-decision').value,
                    justification: document.getElementById('inp-fundamentacion').value,
                    attendance: document.getElementById('inp-asistencia').value
                },
                tutoria: {
                    tutor1: document.getElementById('inp-tutor').value,
                    reportDate: document.getElementById('inp-fecha-tut').value,
                    sem2: { agreements: document.getElementById('inp-acciones').value } // Guardado legacy
                },
                savedAt: new Date().toISOString()
            };

            try {
                await db.collection('artifacts').doc('liceo-agricola').collection('public').doc('data').collection('informes')
                        .doc('REP_' + rut.replace(/[^0-9kK]/g, '')).set(reportData);
                Swal.fire('Guardado', 'Informe registrado.', 'success');
                loadHistory();
            } catch (e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
        };

        window.loadHistory = async () => {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';
            try {
                const snap = await db.collection('artifacts').doc('liceo-agricola').collection('public').doc('data').collection('informes').get();
                tbody.innerHTML = '';
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Sin informes.</td></tr>'; return; }

                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.savedAt ? new Date(d.savedAt).toLocaleDateString() : '---';
                    const type = d.decision?.status || 'Informe';
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">${date}</td>
                            <td class="px-4 py-2"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold">${type}</span></td>
                            <td class="px-4 py-2">${d.student?.name || '---'}</td>
                            <td class="px-4 py-2">${d.student?.course || '---'}</td>
                            <td class="px-4 py-2 text-right"><button onclick="loadReport('${doc.id}')" class="text-blue-600 hover:text-blue-800 underline text-xs font-bold">ABRIR</button></td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        };

        window.loadReport = async (id) => {
            try {
                const docSnap = await db.collection('artifacts').doc('liceo-agricola').collection('public').doc('data').collection('informes').doc(id).get();
                if(docSnap.exists) {
                    const d = docSnap.data();
                    document.getElementById('inp-nombre').value = d.student?.name || '';
                    document.getElementById('inp-rut').value = d.student?.run || '';
                    document.getElementById('inp-curso').value = d.student?.course || '';
                    document.getElementById('inp-profesor').value = d.student?.tutor || '';
                    
                    document.getElementById('inp-sem1').value = d.academic?.sem1Avg || 0;
                    document.getElementById('inp-sem2').value = d.academic?.sem2Avg || 0;
                    document.getElementById('inp-prom-curso').value = d.academic?.courseAvg || 5.5;
                    
                    document.getElementById('inp-analisis-ped').value = d.decree67Analysis?.progress || '';
                    document.getElementById('inp-analisis-soc').value = d.decree67Analysis?.socioemotional || '';
                    
                    document.getElementById('inp-decision').value = d.decision?.status || 'Repitencia';
                    document.getElementById('inp-fundamentacion').value = d.decision?.justification || '';
                    document.getElementById('inp-asignaturas').value = d.academic?.failedSubjectsText || d.decision?.failedSubjects || '';
                    document.getElementById('inp-asistencia').value = d.decision?.attendance || '';
                    
                    document.getElementById('inp-tutor').value = d.tutoria?.tutor1 || '';
                    
                    updateChart();
                    updateTutoriaHeader();
                    switchTab('ficha');
                    Swal.fire('Cargado', 'Informe recuperado.', 'success');
                }
            } catch (e) { console.error(e); }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-${tab}`).classList.add('active');
            
            if(tab === 'historial') loadHistory();
            if(tab === 'analisis') setTimeout(updateChart, 200);
        }

        window.updateTutoriaHeader = () => {
            document.getElementById('view-nombre').textContent = document.getElementById('inp-nombre').value;
            document.getElementById('view-curso').textContent = document.getElementById('inp-curso').value;
            document.getElementById('view-tutor').textContent = document.getElementById('inp-tutor').value;
            document.getElementById('view-sign-tutor').textContent = document.getElementById('inp-tutor').value;
        };

        window.addTutoriaRow = () => {
            const sem = document.getElementById('tut-semestre').value;
            const fechaInp = document.getElementById('tut-fecha').value;
            const obs = document.getElementById('tut-obs').value;
            const acu = document.getElementById('tut-acuerdos').value;

            if(!fechaInp || !obs) return Swal.fire('Falta informaci√≥n', 'Ingresa al menos fecha y observaci√≥n.', 'warning');

            const parts = fechaInp.split('-');
            const fechaStr = `${parts[2]}/${parts[1]}`;

            const tbody = document.getElementById(sem === '1' ? 'table-sem1' : 'table-sem2').querySelector('tbody');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="font-bold border px-2 py-1 align-top">${fechaStr}</td>
                <td class="border px-2 py-1 align-top">${obs}</td>
                <td class="border px-2 py-1 align-top italic text-gray-700">${acu || '-'}</td>
            `;
            
            tr.ondblclick = function() { if(confirm('¬øBorrar esta l√≠nea?')) this.remove(); };
            tr.title = "Doble clic para borrar esta fila";
            
            tbody.appendChild(tr);

            document.getElementById('tut-obs').value = '';
            document.getElementById('tut-acuerdos').value = '';
        };

        window.printReport = (type) => {
            const getVal = (id) => document.getElementById(id).value || "---";
            let content = '';

            if (type === 'tutoria') {
                content = document.getElementById('hoja-tutoria-visual').outerHTML;
            } else {
                const p1 = parseFloat(getVal('inp-sem1')) || 0;
                const p2 = parseFloat(getVal('inp-sem2')) || 0;
                const promAlumno = ((p1 + p2) / 2).toFixed(1);
                const promCurso = parseFloat(getVal('inp-prom-curso')) || 5.5;
                const pctAlumno = Math.min((promAlumno / 7) * 100, 100);
                const pctCurso = Math.min((promCurso / 7) * 100, 100);
                const colorAlumno = promAlumno < 4.0 ? '#ef4444' : '#3b82f6';

                const visualGraph = `
                    <div style="margin-top:10px; border:1px solid #ddd; padding:10px; border-radius:4px; margin-bottom:15px; page-break-inside: avoid;">
                        <div class="visual-bar-container">
                            <div class="visual-bar-label">Promedio Alumno (${promAlumno}):</div>
                            <div class="visual-bar-track"><div class="visual-bar-fill" style="width:${pctAlumno}%; background-color:${colorAlumno} !important; -webkit-print-color-adjust: exact;"></div></div>
                        </div>
                        <div class="visual-bar-container">
                            <div class="visual-bar-label">Promedio Curso (${promCurso}):</div>
                            <div class="visual-bar-track"><div class="visual-bar-fill" style="width:${pctCurso}%; background-color:#9ca3af !important; -webkit-print-color-adjust: exact;"></div></div>
                        </div>
                    </div>
                `;

                content = `
                    <div class="doc-container">
                        <div class="doc-header">
                            <div style="display:flex; gap:15px; align-items:center;">
                                <img src="logo.jpg" style="height:70px;" onerror="this.style.display='none'">
                                <div>
                                    <h2 style="margin:0; font-weight:bold; font-size:12pt; text-transform:uppercase;">${SCHOOL_NAME}</h2>
                                    <p style="margin:0; font-size:10pt;">${LOCATION} ‚Ä¢ UTP</p>
                                </div>
                            </div>
                            <div style="text-align:right; font-size:10pt;">
                                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="doc-title">INFORME DE SITUACI√ìN ACAD√âMICA</div>
                        
                        <div class="doc-section">I. ANTECEDENTES</div>
                        <table style="width:100%; margin-bottom:10px;">
                            <tr><td><strong>Nombre:</strong> ${getVal('inp-nombre')}</td><td><strong>RUT:</strong> ${getVal('inp-rut')}</td></tr>
                            <tr><td><strong>Curso:</strong> ${getVal('inp-curso')}</td><td><strong>Asistencia:</strong> ${getVal('inp-asistencia')}</td></tr>
                        </table>

                        <div class="doc-section">II. AN√ÅLISIS DECRETO 67</div>
                        ${visualGraph}
                        
                        <div style="margin-top:15px;">
                            <p class="doc-field"><strong>An√°lisis Pedag√≥gico:</strong></p>
                            <div class="doc-box">${getVal('inp-analisis-ped')}</div>
                        </div>
                        
                        <div style="margin-top:15px;">
                            <p class="doc-field"><strong>Factores Socioemocionales:</strong></p>
                            <div class="doc-box">${getVal('inp-analisis-soc')}</div>
                        </div>

                        <div class="doc-section">III. RESOLUCI√ìN</div>
                        <p class="doc-field"><strong>Decisi√≥n Final:</strong> <span style="border:1px solid black; padding:2px 5px; font-weight:bold;">${getVal('inp-decision')}</span></p>
                        <p class="doc-field"><strong>Fundamentaci√≥n:</strong></p>
                        <div class="doc-box" style="min-height:100px;">${getVal('inp-fundamentacion')}</div>

                        <div class="doc-signatures">
                            <div class="doc-sign-line">
                                ${getVal('inp-profesor')}<br>
                                <span style="font-weight:normal; font-size:9pt;">Profesor Tutor/Jefe</span>
                            </div>
                            <div class="doc-sign-line">
                                Alejandra Morales G.<br>
                                <span style="font-weight:normal; font-size:9pt;">Unidad T√©cnico Pedag√≥gica</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('print-zone').innerHTML = content;
            window.print();
        };

    </script>
</body>
</html>