<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Docente - Plataforma Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }

        /* --- ESTILOS INTERFAZ --- */
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-1px); }
        
        /* Estilo para las celdas de notas */
        .grade-cell { min-width: 60px; text-align: center; }
        .empty-grade { color: #cbd5e1; font-style: italic; font-size: 0.7rem; }

        /* --- ESTILOS IMPRESI√ìN --- */
        .print-only { display: none; }
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9pt; }
            .no-print { display: none !important; }
            .print-only { display: flex; }
            .printable-container { width: 100% !important; max-width: 100% !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
            table { width: 100% !important; border-collapse: collapse; }
            th, td { border: 1px solid #94a3b8 !important; padding: 2px 4px !important; }
            
            #printHeader { 
                flex-direction: row; align-items: center; justify-content: center; gap: 20px; 
                margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #0f172a; 
            }
            #printFooter { 
                position: fixed; bottom: 0; width: 100%; text-align: center; 
                font-size: 8pt; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 5px; 
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
            <div class="mb-6">
                <img src="logo.jpg" alt="Logo" class="h-24 mx-auto mb-4 object-contain" onerror="this.style.display='none'">
                <h1 class="text-2xl font-bold text-slate-800">Bienvenido Docente</h1>
                <p class="text-slate-500 text-sm">Inicia sesi√≥n para gestionar tus cursos</p>
            </div>
            
            <form id="loginForm" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Correo Electr√≥nico</label>
                    <input type="email" id="emailInput" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="docente@escuela.cl" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Contrase√±a</label>
                    <input type="password" id="passwordInput" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <div id="authErrorMsg" class="text-rose-500 text-xs text-center font-bold hidden"></div>

                <button type="submit" id="btnLogin" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-md">
                    Ingresar
                </button>
                
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink mx-4 text-slate-300 text-xs">O</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <button type="button" id="btnRegister" class="w-full bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-600 font-bold py-2 rounded-lg transition text-sm">
                    Registrarse (Primera vez)
                </button>
            </form>
        </div>
    </div>

    <div id="printHeader" class="print-only">
        <img src="logo.jpg" alt="Logo" style="height: 50px; width: auto;" onerror="this.style.display='none'">
        <div style="text-align: left;">
            <h1 style="font-size: 16pt; font-weight: bold; margin: 0; color: #0f172a;">Escuela Agr√≠cola Sagrados Corazones</h1>
            <p style="margin: 0; color: #475569; font-size: 10pt;">Gesti√≥n Acad√©mica</p>
        </div>
    </div>

    <div class="printable-container w-full max-w-[95%] bg-white rounded-xl shadow-lg p-6">
        
        <div class="no-print text-center mb-6 relative">
            <button id="btnLogout" class="absolute top-0 right-0 text-xs font-bold text-rose-500 hover:text-rose-700 hover:bg-rose-50 px-3 py-1 rounded border border-rose-200 transition">
                Cerrar Sesi√≥n
            </button>

            <img src="logo.jpg" alt="Logo Escuela" class="h-20 mx-auto mb-3 object-contain hover:scale-105 transition-transform" onerror="this.style.display='none'">
            <h1 class="text-2xl font-bold text-slate-800">Control de Asistencia y Calificaciones</h1>
            
            <div class="mt-3 flex flex-col items-center justify-center gap-1">
                <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                    Panel Docente
                </span>
                <span id="userIdDisplay" class="text-[10px] text-slate-400 font-mono mt-1">Conectando...</span>
                <span id="statusDisplay" class="text-xs font-semibold text-emerald-600">‚óè En l√≠nea</span>
            </div>
            
            <p id="currentDate" class="text-slate-500 text-xs mt-3 font-medium capitalize"></p>
        </div>

        <div id="controlsContainer" class="no-print bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
             <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                 
                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">A√±o Acad√©mico</label>
                    <select id="yearSelector" class="w-full p-2 bg-white border-2 border-indigo-100 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-bold text-indigo-700 cursor-pointer">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                 </div>

                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Clase</label>
                    <select id="classSelector" class="w-full p-2 bg-white border border-slate-300 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-medium text-slate-800 cursor-pointer"></select>
                 </div>
                 
                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                    <input type="date" id="dateSelector" class="w-full p-2 bg-white border border-slate-300 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 font-medium cursor-pointer">
                 </div>

                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Evaluaci√≥n</label>
                    <input type="text" id="evalNameInput" placeholder="Ej: PRUEBA 1" class="w-full p-2 bg-white border border-slate-300 rounded shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 font-medium uppercase" />
                 </div>

                 <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nuevo Estudiante</label>
                    <div class="flex shadow-sm">
                        <input type="text" id="studentNameInput" placeholder="Nombre" class="w-full p-2 border border-slate-300 rounded-l focus:ring-2 focus:ring-emerald-500 outline-none text-sm" />
                        <button id="addStudentBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-3 rounded-r transition">+</button>
                    </div>
                 </div>
                 
                 <div class="md:col-span-1">
                     <button id="saveDataBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow-md btn-action flex items-center justify-center gap-2 text-sm">
                        <span>üíæ</span> Guardar
                     </button>
                 </div>
             </div>
        </div>

        <div id="backToTableContainer" class="no-print hidden mb-4">
             <button id="backToTableBtn" class="text-indigo-600 font-bold hover:underline flex items-center gap-1">‚Üê Volver al Panel Principal</button>
        </div>

        <div id="studentsTableContainer" class="printable-container overflow-x-auto">
            <div id="loadingIndicator" class="text-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                <p class="text-slate-400 font-medium">Cargando tus cursos...</p>
            </div>
            
            <table id="mainTable" class="w-full hidden border-collapse text-sm">
                <thead id="tableHeader" class="bg-slate-100 text-slate-500 uppercase text-xs font-bold border-b-2 border-slate-200">
                    </thead>
                <tbody id="tableBody" class="bg-white">
                    </tbody>
            </table>
        </div>

        <div id="classReportContainer" class="hidden mt-4 printable-container overflow-x-auto"></div>
        <div id="classDetailsContainer" class="hidden mt-4 printable-container overflow-x-auto"></div>
        
        <div id="reportButtons" class="no-print mt-8 pt-6 border-t border-slate-100 flex flex-wrap justify-center gap-4">
            <button id="showReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">üìä Resumen</button>
            <button id="showDetailedReportBtn" class="px-5 py-2 bg-white border border-slate-300 rounded-full text-slate-700 font-bold shadow-sm hover:bg-slate-50 transition text-sm">üìã Detallado</button>
            <button id="printReportBtn" class="px-5 py-2 bg-slate-800 text-white rounded-full font-bold shadow-md hover:bg-slate-900 transition text-sm flex items-center gap-2">üñ®Ô∏è Imprimir</button>
        </div>
    </div>

    <div id="observationModal" class="no-print fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 p-3 flex justify-between items-center">
                <h3 class="text-md font-bold text-white flex items-center gap-2"><span>üí¨</span> <span id="modalTitle">Observaciones</span></h3>
                <button id="closeObservationModalBtn" class="text-white hover:text-gray-200 font-bold text-lg leading-none">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto bg-slate-50 flex-1">
                <div id="observationHistory" class="space-y-2 mb-4"></div>
                <div class="bg-white p-2 rounded border border-slate-200 shadow-sm">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Fecha de Registro</label>
                    <input type="date" id="obsDateInput" class="w-full mb-2 p-1 border border-slate-300 rounded text-sm text-slate-600 font-bold">
                    
                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nueva Observaci√≥n</label>
                    <textarea id="newObservationText" class="w-full text-sm text-slate-700 border border-slate-200 rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none resize-none h-20 placeholder:text-slate-300" placeholder="Escribe aqu√≠..."></textarea>
                </div>
            </div>
            <div class="p-3 bg-white border-t border-slate-100 flex justify-end">
                <button id="saveObservationBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-4 rounded shadow transition text-sm">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="printFooter" class="print-only">Plataforma Docente ‚Ä¢ Escuela Agr√≠cola Sagrados Corazones</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACI√ìN
        const CLAVE_DOCENTE = "ProfeAle"; 
        
        // --- N√ìMINA 2025 (HIST√ìRICA) ---
        const BACKUP_DATA = {
            "Primero Medio A": ['ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'HERN√ÅNDEZ FERN√ÅNDEZ DHARIEN ALEXSANDER', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MARIN MAR√çN IGNACIO ANTONIO', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'QUEZADA NARANJO FELIPE ALONSO', 'QUINTEROS VERGARA FERNANDA FLORENCIA', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS', 'BAEZ DONOSO LUKAS ALFONSO', 'MESA D√çAZ GONZALO IGNACIO', 'BAREA SALGADO SERGIO ALEXANDER'],
            "Primero Medio B": ['ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS', 'ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO', 'ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN', 'CASTILLO MU√ëOZ REN√â ANTONIO', 'CID CERDA MAR√çA EVANGELINA', 'CUMINAO VIDAL CATALINA ANDREA', 'D√çAZ MALUENDA MIGUEL ALBERTO', 'KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL', 'L√ìPEZ ACU√ëA MARCO EMILIO', 'L√ìPEZ NOVOA EYDAN DAMI√ÅN', 'M√âNDEZ SUAZO FABI√ÅN FELIPE', 'MOYA REYES MATEO ANTONIO BENJAM√çN', 'OSES CAMPOS VALENTINA ABIGAIL', 'PALMA ORELLANA ANTONELLA FRANCISCA', 'PEREIRA ORELLANA MONSERRAT ALAMIRA', 'P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA', 'ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD', 'ROJAS LEIVA EDUARDO JAVIER', 'V√ÅSQUEZ AGUILERA SCARLET NICOLE', 'Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN', 'VARGAS MORAGA MARTINA SAYEN', 'SALAZAR SALAS PEDRO JOS√â', 'VERA BRAVO FLORENCIA ANTONIA', 'P√âREZ QUEVEDO CONSTANZA TRINIDAD', 'SALGADO TOLEDO FRANCISCO JAVIER', 'RIQUELME SANTOS BENJAM√çN ALONSO'],
            "Segundo Medio A": ['AHUMADA ROJAS TRINIDAD BEL√âN', 'ESPINOSA TORRES FERNANDA ELENA', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH', 'VIELMA ZABALAGA JOAN MANUEL', 'MEZA COLIM√ÅN ANGEL BLAS', 'PALMA ORELLANA ANTONELLA FRANCISCA'],
            "Segundo Medio B": ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
            "Tercero Medio A": ['ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'CONTRERAS VENEGAS BEL√âN ALEJANDRA', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'JARA SEP√öLVEDA KATRINA DARINKA', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'MORAGA PACHECO RENATO IGNACIO', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'CARO URRUTIA CONSUELO ANTONIA', 'LOBOS C√ÅCERES ANTONIA PAZ'],
            "Tercero Medio C": ['ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'COLLAO MEDINA ANA√çS VALENTINA'],
            "Cuarto Medio A": ['AGURTO CRESPO HOMERO ALEXANDER', 'ANDIA DE LA HOZ CATALINA BELEN', 'FUENTES GONZ√ÅLEZ ESTEBAN ALEXANDER', 'GARC√çA ROJAS SOF√çA ELENA', 'GODOY HERRERA ANTONELLA CONSTANZA PAZ', 'GONZ√ÅLEZ CASTRO KEVIN ALEJANDRO', 'MARCHANT MOR√ÅN P√çA IGNACIA', 'QUINTANA SAN MART√çN ALAN VICENTE', 'RECABAL Y√Å√ëEZ CRISTOFER BASTI√ÅN', 'ROJAS GONZ√ÅLEZ GABRIEL ANTONIO', 'TOLEDO MU√ëOZ ESPERANZA BEL√âN', 'Y√Å√ëEZ GONZ√ÅLEZ FRANCISCA ALEJANDRA'],
            "Cuarto Medio C": ['Josefa Morales', 'Benjam√≠n P√©rez', 'Constanza Varela']
        };

        // --- N√ìMINA 2026 (ACTUALIZADA Y LIMPIA) ---
        const DATA_2026 = {
            "Primero Medio A": [
                '√ÅLVAREZ FA√öNDEZ MATEO VICENTE', 'CASTILLO ARAVENA MAITE PASCAL', 'COLLADO PUENTES SANTINO ALEXANDER', 'CONCHA TORREALBA JOAQU√çN IGNACIO', 'D√çAZ MALUENDA ESTEFAN√çA ANTONIA', 'DONAIRE ROJAS MAITE EMILIA ESTER', 'ESPINOZA CACHA√ëA LISBET ALEXANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'FUENTEMAVIDA BARROS OSCAR ANTONIO', 'JAQUE PACHECO DAMI√ÅN IGNACIO', 'JARAMILLO VILLAR MATT HOST', 'L√ìPEZ ACU√ëA MARCO EMILIO', 'L√ìPEZ VILLAR FRANCO IGNACIO', 'MESA D√çAZ GONZALO IGNACIO', 'MEZA CARRASCO CRISTIAN ALFONSO', 'MORALES GARRIDO NICOL√ÅS ANTONIO', 'ORTEGA DA SILVA EMILIA CATALINA SOPHIA', 'PEREIRA TAPIA KEVIN RUB√âN', 'RAM√çREZ SEP√öLVEDA LUIS JUSTIN JES√öS', 'RAM√çREZ VALD√âS MARTINA POLETTE', 'RECABAL Y√Å√ëEZ TOM√ÅS IGNACIO', 'RODR√çGUEZ SEP√öLVEDA SIMONEY ISAMAR', 'ROJAS √ìRDENES TRACY MAIDEN', 'S√ÅNCHEZ MUNIZAGA ALONDRA ANA√çS', 'SOLIZ OLGUIN BRAYAN', 'VALENZUELA MU√ëOZ MAGDALENA BEL√âN'
            ],
            "Segundo Medio A": [
                'ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'ARAVENA Z√ö√ëIGA NOEM√ç JES√öS DE LAS ESTRELLAS', 'ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'ASTUDILLO CAMPOS CRIST√ìBAL ANTONIO', 'ASTUDILLO V√ÅSQUEZ BRUNO FERNANDO LE√ìN', 'BAEZ DONOSO LUKAS ALFONSO', 'CARO BUSTOS KRISCHNA ESTEFANIA', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'CUMINAO VIDAL CATALINA ANDREA', 'D√çAZ MALUENDA MIGUEL ALBERTO', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'KILTAN GONZ√ÅLEZ DIDIER EZEQUIEL', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'L√ìPEZ NOVOA EYDAN DAMI√ÅN', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MOYA REYES MATEO ANTONIO BENJAM√çN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'OSES CAMPOS VALENTINA ABIGAIL', 'PALMA ORELLANA ANTONELLA FRANCISCA', 'PEREIRA ORELLANA MONSERRAT ALAMIRA', 'P√âREZ ORMAZ√ÅBAL ZADKA ALEJANDRA', 'P√âREZ QUEVEDO CONSTANZA TRINIDAD', 'QUEZADA NARANJO FELIPE ALONSO', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'RIQUELME SANTOS BENJAM√çN ALONSO', 'ROJAS GONZ√ÅLEZ FLORENCIA TRINIDAD', 'ROJAS LEIVA EDUARDO JAVIER', 'SALAZAR SALAS PEDRO JOS√â', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'VARGAS MORAGA MARTINA SAYEN', 'V√ÅSQUEZ AGUILERA SCARLET NICOLE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'VERA BRAVO FLORENCIA ANTONIA', 'Y√Å√ëEZ GONZ√ÅLEZ BRAYAN DAMI√ÅN', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS'
            ],
            "Tercero Medio A": [
                'AHUMADA ROJAS TRINIDAD BEL√âN', 'CORNEJO CASTILLO OSCAR GABRIEL', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MEZA COLIM√ÅN ANGEL BLAS', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MORAGA PACHECO RENATO IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN', 'VIELMA ZABALAGA JOAN MANUEL'
            ],
            "Tercero Medio C": [
                'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'ESPINOSA TORRES FERNANDA ELENA', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SAAVEDRA BRAVO FLORENCIA ALEJANDRA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH'
            ],
            "Cuarto Medio A": [
                'ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARO URRUTIA CONSUELO ANTONIA', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'LOBOS C√ÅCERES ANTONIA PAZ', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS'
            ],
            "Cuarto Medio C": [
                'ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'COLLAO MEDINA ANA√çS VALENTINA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA'
            ]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc",
            authDomain: "asistencia-mi-clase.firebaseapp.com",
            projectId: "asistencia-mi-clase",
            storageBucket: "asistencia-mi-clase.appspot.com",
            messagingSenderId: "552398254230",
            appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7", 
            measurementId: "G-MYR01HM1YE"
        };

        let app, db, auth;
        let currentDateString = new Date().toISOString().slice(0, 10);
        let masterData = {}; 
        let currentYear = "2025"; 
        let allClassesData = {}; 
        let currentClass = null;
        let students = [];
        let currentStudentIndex = -1;
        let userId = null;

        const getEl = (id) => document.getElementById(id);
        const elements = {
            status: getEl('statusDisplay'), userId: getEl('userIdDisplay'), dateText: getEl('currentDate'),
            tableContainer: getEl('studentsTableContainer'), loading: getEl('loadingIndicator'),
            mainTable: getEl('mainTable'), tableHeader: getEl('tableHeader'), tableBody: getEl('tableBody'),
            yearSel: getEl('yearSelector'), classSel: getEl('classSelector'), dateSel: getEl('dateSelector'),
            nameInput: getEl('studentNameInput'), saveBtn: getEl('saveDataBtn'),
            evalName: getEl('evalNameInput'),
            reportBtns: { summary: getEl('showReportBtn'), detail: getEl('showDetailedReportBtn'), print: getEl('printReportBtn'), back: getEl('backToTableBtn') },
            containers: { controls: getEl('controlsContainer'), reportNav: getEl('reportButtons'), backNav: getEl('backToTableContainer'), reportSummary: getEl('classReportContainer'), reportDetail: getEl('classDetailsContainer') },
            modal: { el: getEl('observationModal'), title: getEl('modalTitle'), history: getEl('observationHistory'), input: getEl('newObservationText'), dateInput: getEl('obsDateInput'), save: getEl('saveObservationBtn'), close: getEl('closeObservationModalBtn') },
            auth: { overlay: getEl('loginOverlay'), email: getEl('emailInput'), pass: getEl('passwordInput'), btnLogin: getEl('btnLogin'), btnReg: getEl('btnRegister'), err: getEl('authErrorMsg'), btnLogout: getEl('btnLogout') }
        };

        function getTeacherDocRef() { return doc(db, `registros_publicos/${userId}/coleccion_datos/datos_maestros`); }

        async function initApp() {
             try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                const today = new Date();
                const offset = today.getTimezoneOffset() * 60000;
                currentDateString = new Date(today.getTime() - offset).toISOString().slice(0, 10);
                elements.dateSel.value = currentDateString;
                updateDateDisplay();
                currentYear = "2025"; elements.yearSel.value = "2025";

                onAuthStateChanged(auth, user => {
                    if (user) { 
                        userId = user.uid; elements.userId.textContent = `${user.email}`; elements.status.textContent = '‚óè CONECTADO'; elements.auth.overlay.classList.add('hidden'); 
                        loadData(); 
                    } else { 
                        elements.auth.overlay.classList.remove('hidden'); elements.userId.textContent = "Esperando acceso..."; elements.status.textContent = "‚óè Desconectado";
                    }
                });
                setupListeners();
             } catch (e) { alert('Error de conexi√≥n: ' + e.message); }
        }

        async function handleLogin(e) { e.preventDefault(); elements.auth.err.classList.add('hidden'); try { await signInWithEmailAndPassword(auth, elements.auth.email.value, elements.auth.pass.value); } catch (error) { elements.auth.err.textContent = "Error: " + error.message; elements.auth.err.classList.remove('hidden'); } }
        async function handleRegister() { if(!elements.auth.email.value) return alert("Falta correo"); try { await createUserWithEmailAndPassword(auth, elements.auth.email.value, elements.auth.pass.value); alert("Cuenta creada."); } catch (error) { alert("Error: " + error.message); } }
        async function handleLogout() { if(confirm("¬øCerrar sesi√≥n?")) { await signOut(auth); location.reload(); } }

        function loadData() {
            onSnapshot(getTeacherDocRef(), (docSnap) => {
                elements.loading.style.display = 'none';
                let rawData = docSnap.exists() ? docSnap.data() : null;
                if (!rawData || !rawData["2025"]) { masterData = { "2025": { classes: {} }, "2026": { classes: {} } }; if(rawData && rawData.classes) masterData["2025"].classes = rawData.classes; } else { masterData = rawData; }
                
                let modified = false;
                ["2025", "2026"].forEach(year => {
                    if(!masterData[year]) masterData[year] = { classes: {} };
                    
                    // SELECCIONAR ORIGEN DE DATOS SEG√öN EL A√ëO
                    const sourceData = (year === "2026") ? DATA_2026 : BACKUP_DATA;

                    for (const [clsName, studentList] of Object.entries(sourceData)) {
                        // L√ìGICA DE CORRECCI√ìN AUTOM√ÅTICA:
                        // Si la clase no existe, o est√° vac√≠a, O (IMPORTANTE) si el primer estudiante no coincide con el de la lista oficial,
                        // forzamos la actualizaci√≥n para asegurar que los datos sean correctos.
                        const dbClass = masterData[year].classes[clsName];
                        let needsUpdate = false;

                        if (!dbClass || dbClass.length === 0) {
                            needsUpdate = true;
                        } else if (dbClass.length > 0 && sourceStudentsMatch(dbClass, studentList) === false) {
                            // Si los estudiantes en la BD no coinciden con la lista oficial para este a√±o, actualizamos.
                            console.log(`Corrigiendo n√≥mina para ${year} - ${clsName}`);
                            needsUpdate = true;
                        }

                        if (needsUpdate) {
                            masterData[year].classes[clsName] = studentList.map(name => ({ name: name, grades: [], attendance: {}, observations: [] }));
                            modified = true;
                        }
                    }
                });
                if (modified) saveToCloud(true);
                loadYearData(currentYear);
            });
        }

        // Funci√≥n auxiliar para verificar si la lista de la BD coincide con la fuente
        function sourceStudentsMatch(dbList, sourceList) {
            if (dbList.length !== sourceList.length) return false;
            // Comparamos el primer alumno como referencia r√°pida
            return dbList[0].name === sourceList[0];
        }

        function loadYearData(year) {
            currentYear = year;
            allClassesData = masterData[currentYear].classes || {};
            const classList = Object.keys(allClassesData).sort();
            if (!currentClass || !classList.includes(currentClass)) currentClass = classList[0] || null;
            updateClassSelectorUI(classList, currentClass);
            refreshTable();
        }

        function updateClassSelectorUI(classList, selectedClass) {
            if (Array.from(elements.classSel.options).map(o => o.value).join(',') !== classList.join(',')) 
                elements.classSel.innerHTML = classList.map(k => `<option value="${k}">${k}</option>`).join('');
            elements.classSel.value = selectedClass || "";
        }

        function getUniqueEvaluations(studentList) {
            const evals = new Set();
            studentList.forEach(s => s.grades.forEach(g => evals.add(g.type || "Evaluaci√≥n")));
            return Array.from(evals).sort(); 
        }

        function refreshTable() {
            if(!currentClass) { elements.mainTable.classList.add('hidden'); return; }
            students = allClassesData[currentClass] || [];
            elements.mainTable.classList.remove('hidden');
            
            const evalColumns = getUniqueEvaluations(students);
            
            let headerHtml = `<tr>
                <th class="p-3 text-left border w-48">Estudiante</th>
                <th class="p-3 text-center border w-16">Prom</th>`;
            
            evalColumns.forEach(col => {
                headerHtml += `<th class="p-3 text-center border min-w-[80px] bg-indigo-50 text-indigo-700">${col}</th>`;
            });

            headerHtml += `<th class="p-3 text-center border w-24">Asistencia</th>
                           <th class="p-3 text-center border w-32">Acciones</th>
                           </tr>`;
            elements.tableHeader.innerHTML = headerHtml;

            elements.tableBody.innerHTML = students.map((s, sIdx) => {
                if(!s.grades) s.grades = []; if(!s.attendance) s.attendance = {}; if(!s.observations) s.observations = [];
                const avg = calculateAverage(s.grades);
                const att = s.attendance[currentDateString];
                const hasObs = s.observations.length > 0;

                const gradeCells = evalColumns.map(colName => {
                    const gradeObj = s.grades.slice().reverse().find(g => (g.type || "Evaluaci√≥n") === colName);
                    
                    if (gradeObj) {
                        const realIndex = s.grades.indexOf(gradeObj); 
                        return `
                        <td class="border p-1 text-center bg-slate-50">
                            <div class="flex items-center justify-center gap-1">
                                <span class="font-bold text-slate-700">${gradeObj.value.toFixed(1)}</span>
                                <button onclick="window.editGrade(${sIdx}, ${realIndex})" class="text-[10px] text-indigo-400 hover:text-indigo-700 p-1 bg-white border rounded shadow-sm" title="Editar nota">‚úèÔ∏è</button>
                            </div>
                        </td>`;
                    } else {
                        return `<td class="border p-1 text-center empty-grade">-</td>`;
                    }
                }).join('');

                return `
                <tr class="hover:bg-slate-50 transition">
                    <td class="border p-2 font-medium truncate max-w-[200px]" title="${s.name}">${s.name}</td>
                    <td class="border p-2 text-center font-bold ${parseFloat(avg)<4 ? 'text-red-500':'text-slate-700'}">${avg}</td>
                    ${gradeCells}
                    <td class="border p-1 text-center">
                        <div class="flex justify-center gap-1 scale-90">${renderAttBtn(sIdx,'P','bg-emerald-500',att)}${renderAttBtn(sIdx,'A','bg-rose-500',att)}${renderAttBtn(sIdx,'J','bg-amber-400',att)}</div>
                    </td>
                    <td class="border p-1">
                         <div class="flex items-center justify-end gap-2 pr-2">
                            <div class="flex items-center border border-slate-300 rounded overflow-hidden bg-white shadow-sm">
                                <input type="number" id="grade-${sIdx}" step="0.1" placeholder="-" class="w-12 text-center text-xs outline-none p-1 font-bold text-slate-700">
                                <button onclick="window.addGrade(${sIdx})" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-2 py-1 font-bold border-l border-slate-300 text-xs transition">+</button>
                            </div>
                            <button onclick="window.openModal(${sIdx})" class="w-7 h-7 rounded-full flex items-center justify-center transition ${hasObs?'bg-indigo-100 text-indigo-600 shadow-sm':'bg-slate-100 text-slate-400 hover:bg-slate-200'}">${hasObs?'üìù':'üí¨'}</button>
                            <button onclick="window.deleteStudent(${sIdx})" class="text-slate-300 hover:text-rose-500 transition">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderAttBtn(idx, t, c, cur) { return `<button onclick="window.setAtt(${idx}, '${t}')" class="w-6 h-6 rounded-full text-[10px] font-bold transition-transform ${cur===t?`${c} text-white scale-110 shadow-md`:'bg-slate-100 text-slate-400 hover:bg-slate-200'}">${t}</button>`; }

        window.setAtt = (idx, status) => { students[idx].attendance[currentDateString] = status; saveLocal(); };
        
        window.addGrade = (idx) => { 
            const v = parseFloat(getEl(`grade-${idx}`).value); 
            if(isNaN(v)||v<1||v>7) return alert('Nota inv√°lida'); 
            const evalType = elements.evalName.value.trim().toUpperCase() || "EVALUACI√ìN GENERAL";
            
            const exists = students[idx].grades.find(g => (g.type || "Evaluaci√≥n") === evalType);
            if(exists) {
                if(!confirm(`El estudiante ya tiene nota para "${evalType}" (${exists.value}). ¬øDesea agregar otra igual?`)) return;
            }

            students[idx].grades.push({ value: v, date: currentDateString, type: evalType, id: Date.now() }); 
            getEl(`grade-${idx}`).value=''; 
            saveLocal(); 
        };

        window.editGrade = (sIdx, gIdx) => { 
            const g = students[sIdx].grades[gIdx]; 
            const currentType = g.type || "Evaluaci√≥n";
            const newVal = prompt(`Editar Nota: ${currentType}\nValor actual: ${g.value}\n\n- Escribe nuevo n√∫mero para cambiar.\n- Escribe 'borrar' para eliminar.`, g.value);
            
            if(newVal === null) return; 
            if(newVal.toLowerCase() === 'borrar') {
                students[sIdx].grades.splice(gIdx, 1); 
            } else {
                const num = parseFloat(newVal);
                if(!isNaN(num) && num >= 1 && num <= 7) {
                    students[sIdx].grades[gIdx].value = num;
                } else {
                    alert("Valor inv√°lido");
                }
            }
            saveLocal(); 
        };

        window.deleteStudent = (idx) => { if(confirm('¬øEliminar estudiante?')) { students.splice(idx, 1); saveLocal(); } };
        
        window.openModal = (idx) => { 
            currentStudentIndex = idx; 
            elements.modal.el.classList.remove('hidden','flex'); 
            elements.modal.el.classList.add('flex'); 
            elements.modal.title.textContent=students[idx].name; 
            elements.modal.dateInput.value = currentDateString; // Asignar fecha actual al input
            renderHistory(students[idx].observations||[]); 
        };

        function saveLocal() { masterData[currentYear].classes[currentClass] = students; refreshTable(); }
        async function saveToCloud(silent = false) { if(!auth.currentUser) return; try { await setDoc(getTeacherDocRef(), masterData); if(!silent) { const btn = elements.saveBtn; const orig = btn.innerHTML; btn.innerHTML = "‚úÖ Guardado"; btn.classList.add('bg-emerald-600'); setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('bg-emerald-600'); }, 2000); } } catch(e) { alert('Error: ' + e.message); } }
        function calculateAverage(g) { if(!g.length) return '0.0'; return (g.reduce((a,b)=>a+b.value,0)/g.length).toFixed(1); }
        function updateDateDisplay() { const d = new Date(currentDateString + 'T12:00:00'); elements.dateText.textContent = d.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }
        
        // --- ORDENAR OBSERVACIONES POR FECHA ---
        function renderHistory(l) { 
            const s = [...l].sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            elements.modal.history.innerHTML = s.length?s.map(o=>`<div class="bg-white border-l-4 border-indigo-400 p-2 rounded shadow-sm text-xs"><div class="flex justify-between text-[10px] text-slate-400 mb-1"><span class="font-bold text-indigo-600 bg-indigo-50 px-1 rounded">${o.date}</span></div><p class="text-slate-700">${o.text}</p></div>`).join(''):'<p class="text-center text-slate-400 italic text-xs">Sin registros.</p>'; 
        }

        function setupListeners() {
            elements.saveBtn.onclick = () => saveToCloud(false);
            elements.yearSel.onchange = (e) => loadYearData(e.target.value);
            elements.classSel.onchange = (e) => { currentClass = e.target.value; refreshTable(); };
            elements.dateSel.onchange = (e) => { currentDateString = e.target.value; updateDateDisplay(); refreshTable(); };
            getEl('addStudentBtn').onclick = () => { const n = elements.nameInput.value.trim().toUpperCase(); if(n&&currentClass&&!students.find(s=>s.name===n)) { students.push({ name: n, grades: [], attendance: {}, observations: [] }); elements.nameInput.value=''; saveLocal(); } };
            elements.modal.close.onclick = () => elements.modal.el.classList.add('hidden');
            
            // --- GUARDAR OBSERVACI√ìN CON FECHA SELECCIONADA ---
            elements.modal.save.onclick = () => { 
                const t = elements.modal.input.value.trim(); 
                const d = elements.modal.dateInput.value;
                if(t && d) { 
                    students[currentStudentIndex].observations.push({ text: t, date: d, id: Date.now() }); 
                    elements.modal.el.classList.add('hidden'); 
                    elements.modal.input.value=''; 
                    saveLocal(); 
                } else if (!d) {
                    alert("Por favor selecciona una fecha.");
                }
            };
            
            elements.reportBtns.back.onclick = () => { 
                elements.tableContainer.classList.remove('hidden'); 
                elements.containers.controls.classList.remove('hidden'); 
                elements.containers.reportSummary.classList.add('hidden'); 
                elements.containers.reportDetail.classList.add('hidden'); 
                elements.containers.backNav.classList.add('hidden'); 
                refreshTable(); 
            };
            
            elements.reportBtns.print.onclick = () => window.print();
            elements.reportBtns.summary.onclick = generateSummary;
            elements.reportBtns.detail.onclick = generateDetail;
            
            elements.auth.btnLogin.onclick = handleLogin;
            elements.auth.btnReg.onclick = handleRegister;
            elements.auth.btnLogout.onclick = handleLogout;
        }

        function generateSummary() {
            if(!allClassesData || Object.keys(allClassesData).length === 0) return alert("No hay datos cargados.");
            elements.tableContainer.classList.add('hidden'); 
            elements.containers.controls.classList.add('hidden');
            elements.containers.backNav.classList.remove('hidden'); 
            elements.containers.reportSummary.classList.remove('hidden');
            elements.containers.reportDetail.classList.add('hidden'); 

            const data = Object.keys(allClassesData).map(cls => { const list = allClassesData[cls]; let p=0, a=0, j=0, total=0; list.forEach(s => Object.values(s.attendance||{}).forEach(v => { if(v==='P')p++; if(v==='A')a++; if(v==='J')j++; total++; })); return { cls, count: list.length, p, a, j, rate: total ? ((p+j)/total*100).toFixed(1)+'%' : 'N/A' }; });
            elements.containers.reportSummary.innerHTML = `<h2 class="text-xl font-bold text-slate-800 mb-4 text-center border-b pb-2">Resumen ${currentYear}</h2><table class="w-full text-sm text-left text-slate-600"><thead class="bg-slate-100 text-xs uppercase"><tr><th class="px-4 py-2">Clase</th><th class="px-4 py-2 text-center">Matr√≠cula</th><th class="text-center px-4 py-2 text-emerald-600">Presentes</th><th class="text-center px-4 py-2 text-rose-600">Ausentes</th><th class="text-center px-4 py-2 text-amber-600">Justif.</th><th class="text-center px-4 py-2">% Asist.</th></tr></thead><tbody>${data.map(d=>`<tr class="border-b"><td class="px-4 py-3 font-medium">${d.cls}</td><td class="text-center">${d.count}</td><td class="text-center font-bold text-emerald-600">${d.p}</td><td class="text-center font-bold text-rose-600">${d.a}</td><td class="text-center font-bold text-amber-600">${d.j}</td><td class="text-center font-bold">${d.rate}</td></tr>`).join('')}</tbody></table>`;
        }
        
        function generateDetail() {
            if(!currentClass) return alert("Selecciona una clase primero.");
            elements.tableContainer.classList.add('hidden'); 
            elements.containers.controls.classList.add('hidden');
            elements.containers.backNav.classList.remove('hidden'); 
            elements.containers.reportDetail.classList.remove('hidden');
            elements.containers.reportSummary.classList.add('hidden');

            const list = allClassesData[currentClass]; 
            const datesSet = new Set(); 
            list.forEach(s => Object.keys(s.attendance||{}).forEach(d => datesSet.add(d))); 
            const sortedDates = Array.from(datesSet).sort();

            const evalColumns = getUniqueEvaluations(list);

            elements.containers.reportDetail.innerHTML = `
            <h2 class="text-xl font-bold text-slate-800 mb-4 text-center border-b pb-2">Detalle: ${currentClass} (${currentYear})</h2>
            <table class="w-full text-xs text-slate-600 border border-slate-200">
                <thead class="bg-slate-100 uppercase">
                    <tr>
                        <th class="px-2 py-2 text-left border w-48">Estudiante</th>
                        <th class="px-1 py-2 text-center border w-12 bg-slate-200">Prom</th>
                        ${evalColumns.map(e => `<th class="px-1 py-2 text-center border bg-indigo-50 text-indigo-800 w-16">${e}</th>`).join('')}
                        ${sortedDates.map(d=>`<th class="px-1 py-2 text-center border w-10">${d.slice(5)}</th>`).join('')}
                        <th class="px-2 py-2 text-left border w-48">Observaciones</th> </tr>
                </thead>
                <tbody>
                    ${list.map((s,i)=>{ 
                        const gradeCells = evalColumns.map(col => {
                            const g = s.grades.slice().reverse().find(gr => (gr.type || "Evaluaci√≥n") === col);
                            return `<td class="text-center border font-bold ${g ? 'text-slate-700' : 'text-slate-200'}">${g ? g.value.toFixed(1) : '-'}</td>`;
                        }).join('');

                        const attCells = sortedDates.map(d=>{ 
                            const v=s.attendance[d]||'-'; 
                            let c='text-slate-300'; 
                            if(v==='P')c='bg-emerald-100 text-emerald-700 font-bold'; 
                            if(v==='A')c='bg-rose-100 text-rose-700 font-bold'; 
                            if(v==='J')c='bg-amber-100 text-amber-700 font-bold'; 
                            return `<td class="text-center border ${c}">${v}</td>`; 
                        }).join(''); 

                        // --- RENDERIZADO DE OBSERVACIONES EN EL REPORTE ---
                        const obsHtml = s.observations
                            .sort((a,b) => new Date(b.date) - new Date(a.date)) // Ordenar por fecha
                            .map(o=>`<div class="mb-1 border-b border-slate-100 pb-1 last:border-0"><strong class="text-indigo-600 text-[10px]">${o.date}:</strong> ${o.text}</div>`)
                            .join('');

                        return `<tr class="${i%2===0?'bg-white':'bg-slate-50'}"><td class="px-2 py-2 border font-medium truncate max-w-[150px]">${s.name}</td><td class="px-1 py-2 border text-center font-bold bg-slate-50 text-black">${calculateAverage(s.grades)}</td>${gradeCells}${attCells}<td class="px-2 py-2 border leading-tight text-[10px]">${obsHtml}</td></tr>`; 
                    }).join('')}
                </tbody>
            </table>`;
        }

        window.onload = initApp;
    </script>
</body>
</html>