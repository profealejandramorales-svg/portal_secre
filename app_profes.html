<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Docente (Privada)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .grade-chip { cursor: pointer; transition: all 0.2s; }
        .grade-chip:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Estilos Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center w-96">
            <div class="mb-6">
                <i class="fas fa-user-shield text-5xl text-indigo-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Acceso Docente</h1>
            <p class="text-gray-500 mb-6 text-sm">Tus notas y observaciones están seguras aquí.</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-50 transition shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Iniciar con Google
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-container" class="hidden max-w-7xl mx-auto p-4 md:p-6">
        
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="" class="w-10 h-10 rounded-full border-2 border-indigo-200">
                <div>
                    <h2 id="user-name" class="font-bold text-gray-800 text-sm">Cargando...</h2>
                    <p class="text-xs text-green-600 font-bold">● Conectado (Modo Privado)</p>
                </div>
            </div>
            <button onclick="logout()" class="text-xs text-red-500 font-bold hover:bg-red-50 px-3 py-1 rounded border border-red-200">
                Cerrar Sesión
            </button>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-xl shadow-sm">
            <div>
                <h1 class="text-2xl font-bold text-indigo-800">Libro de Clases Digital</h1>
                <p class="text-sm text-gray-500">Gestión de Notas y Observaciones</p>
            </div>
            <div class="flex gap-2">
                <select id="yearSelector" onchange="changeYear()" class="border-2 border-indigo-100 rounded-lg px-3 py-2 text-sm font-bold text-indigo-700 focus:outline-none focus:border-indigo-500">
                    <option value="2025">Año 2025</option>
                    <option value="2026">Año 2026</option>
                </select>
                <button onclick="resetYear()" class="text-xs text-red-400 hover:text-red-600 font-bold px-2">⚠ Reset Año</button>
            </div>
        </div>

        <div class="flex gap-2 mb-6 overflow-x-auto pb-2" id="classTabs">
            </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-600 font-bold uppercase text-xs border-b">
                        <tr>
                            <th class="p-4 w-10">#</th>
                            <th class="p-4 w-64">Estudiante</th>
                            <th class="p-4 text-center w-32">Promedio</th>
                            <th class="p-4">Calificaciones (Click para editar)</th>
                            <th class="p-4 text-center w-24">Obs.</th>
                            <th class="p-4 text-right">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            
            <div class="p-4 bg-gray-50 border-t flex justify-between items-center">
                <button onclick="addStudent()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-xs flex items-center gap-2 shadow-sm transition">
                    <span>+</span> Nuevo Estudiante
                </button>
                <div class="text-xs text-gray-400 font-mono" id="last-saved">Sin cambios</div>
            </div>
        </div>
    </div>

    <div id="obsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="bg-indigo-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold" id="modalTitle">Observaciones</h3>
                <button onclick="document.getElementById('obsModal').classList.add('hidden')" class="text-white hover:text-indigo-200 text-xl">&times;</button>
            </div>
            <div class="p-6">
                <div id="obsHistory" class="mb-4 max-h-60 overflow-y-auto space-y-2 bg-gray-50 p-2 rounded"></div>
                <textarea id="obsInput" class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" rows="3" placeholder="Escriba nueva observación..."></textarea>
                <button onclick="saveObs()" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition">Guardar Observación</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN FIREBASE (Tus credenciales)
        const firebaseConfig = { apiKey: "AIzaSyDUArOBUzzvulHYQGA7IvnEwo2jQbEa3Xs", authDomain: "attendance-ai-s81lt.firebaseapp.com", projectId: "attendance-ai-s81lt", storageBucket: "attendance-ai-s81lt.firebasestorage.app", messagingSenderId: "935781953186", appId: "1:935781953186:web:6c8a7a93ffad180d33b1fb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Variables Globales
        let currentUser = null;
        let masterData = {};
        let currentYear = "2025";
        let currentClass = "1° Medio A";
        let currentStudentIdx = null;
        const DEFAULT_CLASSES = ["1° Medio A", "1° Medio B", "2° Medio A", "2° Medio B", "3° Medio A", "3° Medio B", "4° Medio A", "4° Medio B"];

        // --- SISTEMA DE AUTENTICACIÓN ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                // UI Usuario
                document.getElementById('user-name').innerText = user.displayName || user.email;
                document.getElementById('user-photo').src = user.photoURL || "https://ui-avatars.com/api/?name=" + (user.displayName || "Docente");
                
                loadUserData(); // Cargar datos privados
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                document.getElementById('login-error').innerText = error.message;
                document.getElementById('login-error').classList.remove('hidden');
            });
        }

        function logout() {
            auth.signOut();
            location.reload();
        }

        // --- GESTIÓN DE DATOS (PRIVADO POR UID) ---
        async function loadUserData() {
            if (!currentUser) return;
            
            // RUTA PRIVADA: docentes/{uid}/data/libro_clases
            const docRef = db.collection('docentes').doc(currentUser.uid).collection('data').doc('libro_clases');
            
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    masterData = doc.data();
                    // Migración simple si faltan años
                    if (!masterData["2025"]) masterData["2025"] = createYearStructure();
                    if (!masterData["2026"]) masterData["2026"] = createYearStructure();
                } else {
                    // Crear estructura inicial nueva para este profe
                    masterData = {
                        "2025": createYearStructure(),
                        "2026": createYearStructure()
                    };
                    await docRef.set(masterData);
                }
                renderApp();
            } catch (e) {
                console.error("Error cargando datos:", e);
                alert("Error de conexión. Intente recargar.");
            }
        }

        async function saveData() {
            if (!currentUser) return;
            const docRef = db.collection('docentes').doc(currentUser.uid).collection('data').doc('libro_clases');
            
            try {
                await docRef.set(masterData);
                const now = new Date();
                document.getElementById('last-saved').innerText = "Guardado: " + now.toLocaleTimeString();
            } catch (e) {
                alert("Error al guardar en la nube.");
            }
        }

        // --- LÓGICA DE LA APP (Igual que antes, pero conectada a masterData) ---
        function createYearStructure() {
            let structure = { classes: {} };
            DEFAULT_CLASSES.forEach(cls => {
                structure.classes[cls] = []; // Lista vacía de estudiantes
            });
            return structure;
        }

        function renderApp() {
            renderTabs();
            renderTable();
        }

        function renderTabs() {
            const container = document.getElementById('classTabs');
            container.innerHTML = '';
            
            // Obtener clases del año actual
            const classes = Object.keys(masterData[currentYear].classes).sort();
            
            classes.forEach(cls => {
                const btn = document.createElement('button');
                const isActive = cls === currentClass;
                btn.className = `px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-500 hover:bg-gray-50 border'}`;
                btn.innerText = cls;
                btn.onclick = () => { currentClass = cls; renderTabs(); renderTable(); };
                container.appendChild(btn);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';
            
            const students = masterData[currentYear].classes[currentClass] || [];

            if (students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400 italic">No hay estudiantes en este curso. Agrega uno abajo.</td></tr>`;
                return;
            }

            students.forEach((student, idx) => {
                const avg = calculateAverage(student.grades);
                const avgColor = getAvgColor(avg);
                
                let gradesHtml = student.grades.map((g, i) => 
                    `<span onclick="editGrade(${idx}, ${i})" class="grade-chip inline-block w-8 h-8 leading-8 text-center rounded-full text-xs font-bold mr-1 ${g >= 4 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">${g}</span>`
                ).join('');
                
                gradesHtml += `<button onclick="addGrade(${idx})" class="w-8 h-8 rounded-full border-2 border-dashed border-gray-300 text-gray-400 hover:border-indigo-400 hover:text-indigo-500 text-xs font-bold transition">+</button>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition group">
                        <td class="p-4 text-gray-400 text-xs">${idx + 1}</td>
                        <td class="p-4 font-bold text-gray-700">${student.name}</td>
                        <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-sm font-bold ${avgColor}">${avg}</span></td>
                        <td class="p-4">${gradesHtml}</td>
                        <td class="p-4 text-center">
                            <button onclick="openObsModal(${idx})" class="relative text-gray-400 hover:text-indigo-600 transition">
                                <i class="fas fa-comment-alt"></i>
                                ${student.observations.length > 0 ? `<span class="absolute -top-2 -right-2 w-4 h-4 bg-red-500 text-white text-[9px] flex items-center justify-center rounded-full">${student.observations.length}</span>` : ''}
                            </button>
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="deleteStudent(${idx})" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- FUNCIONES AUXILIARES ---
        function calculateAverage(grades) {
            if (grades.length === 0) return '-';
            const sum = grades.reduce((a, b) => a + parseFloat(b), 0);
            return (sum / grades.length).toFixed(1);
        }

        function getAvgColor(avg) {
            if (avg === '-') return 'bg-gray-100 text-gray-400';
            const num = parseFloat(avg);
            if (num >= 6.0) return 'bg-green-100 text-green-700';
            if (num >= 4.0) return 'bg-blue-100 text-blue-700';
            return 'bg-red-100 text-red-700';
        }

        // --- ACCIONES ---
        function addStudent() {
            const name = prompt("Nombre del Estudiante:");
            if (name) {
                if (!masterData[currentYear].classes[currentClass]) masterData[currentYear].classes[currentClass] = [];
                
                masterData[currentYear].classes[currentClass].push({
                    name: name,
                    grades: [],
                    observations: []
                });
                saveData();
                renderTable();
            }
        }

        function deleteStudent(idx) {
            if(confirm("¿Eliminar estudiante y sus notas?")) {
                masterData[currentYear].classes[currentClass].splice(idx, 1);
                saveData();
                renderTable();
            }
        }

        function addGrade(studentIdx) {
            const val = prompt("Ingrese nota (1.0 - 7.0):");
            if (val) {
                const num = parseFloat(val.replace(',', '.'));
                if (num >= 1.0 && num <= 7.0) {
                    masterData[currentYear].classes[currentClass][studentIdx].grades.push(num);
                    saveData();
                    renderTable();
                } else {
                    alert("Nota inválida");
                }
            }
        }

        function editGrade(studentIdx, gradeIdx) {
            const oldVal = masterData[currentYear].classes[currentClass][studentIdx].grades[gradeIdx];
            const val = prompt("Editar nota (o dejar vacío para borrar):", oldVal);
            
            if (val === "") {
                // Borrar
                masterData[currentYear].classes[currentClass][studentIdx].grades.splice(gradeIdx, 1);
            } else if (val) {
                // Editar
                const num = parseFloat(val.replace(',', '.'));
                if (num >= 1.0 && num <= 7.0) {
                    masterData[currentYear].classes[currentClass][studentIdx].grades[gradeIdx] = num;
                } else {
                    alert("Nota inválida");
                    return;
                }
            }
            saveData();
            renderTable();
        }

        // --- OBSERVACIONES ---
        function openObsModal(idx) {
            currentStudentIdx = idx;
            const student = masterData[currentYear].classes[currentClass][idx];
            document.getElementById('modalTitle').innerText = student.name;
            document.getElementById('obsModal').classList.remove('hidden');
            
            const container = document.getElementById('obsHistory');
            container.innerHTML = '';
            
            if (student.observations.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 italic text-center">Sin observaciones.</p>';
            } else {
                student.observations.forEach(obs => {
                    container.innerHTML += `
                        <div class="bg-white p-2 rounded border border-gray-200 text-sm shadow-sm">
                            <div class="text-xs text-indigo-600 font-bold mb-1">${obs.date}</div>
                            <div class="text-gray-700">${obs.text}</div>
                        </div>
                    `;
                });
            }
        }

        function saveObs() {
            const text = document.getElementById('obsInput').value;
            if (text.trim()) {
                const date = new Date().toLocaleDateString('es-CL');
                masterData[currentYear].classes[currentClass][currentStudentIdx].observations.push({
                    text: text,
                    date: date
                });
                document.getElementById('obsInput').value = '';
                document.getElementById('obsModal').classList.add('hidden');
                saveData();
                renderTable();
            }
        }

        function changeYear() {
            currentYear = document.getElementById('yearSelector').value;
            renderTabs(); // Las clases pueden ser las mismas, pero refrescamos por si acaso
            renderTable();
        }

        function resetYear() {
            if(confirm("⚠️ ¿Estás seguro de BORRAR TODOS los datos del año " + currentYear + "? Esta acción no se puede deshacer.")) {
                masterData[currentYear] = createYearStructure();
                saveData();
                renderTable();
            }
        }

    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>